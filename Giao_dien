!pip install gradio -q

import gradio as gr
import cv2, numpy as np
from tensorflow.keras.models import load_model
from PIL import Image

# -----------------------------
# Load láº¡i mÃ´ hÃ¬nh ANN
# -----------------------------
MODEL_PATH = "/content/drive/MyDrive/money_ann_model.h5"
model = load_model(MODEL_PATH)
print("âœ… ÄÃ£ load mÃ´ hÃ¬nh ANN thÃ nh cÃ´ng!")

# ThÃ´ng tin class
CLASS_NAMES = ["1k","2k","5k","10k","20k","50k","100k","200k","500k"]
IMG_WIDTH, IMG_HEIGHT = 100, 50

# ThÃ´ng tin lá»‹ch sá»­ ra Ä‘á»i (báº¡n cÃ³ thá»ƒ chá»‰nh thÃªm)
history_info = {
    "1k": """PhÃ¡t hÃ nh: cotton nÄƒm 1989.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: Cáº£nh khai thÃ¡c gá»— á»Ÿ TÃ¢y NguyÃªn.""",

    "2k": """PhÃ¡t hÃ nh: cotton nÄƒm 1989.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: HÃ¬nh áº£nh cÃ´ng nhÃ¢n táº¡i NhÃ  mÃ¡y Dá»‡t Nam Äá»‹nh.""",

    "5k": """PhÃ¡t hÃ nh: cotton nÄƒm 1990,.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: NhÃ  mÃ¡y Thá»§y Ä‘iá»‡n Trá»‹ An, trÃªn sÃ´ng Äá»“ng Nai.""",

    "10k": """PhÃ¡t hÃ nh: cotton trÆ°á»›c 2006, polymer tá»« 2006.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: Má» dáº§u Báº¡ch Há»•.""",

    "20k": """PhÃ¡t hÃ nh: cotton trÆ°á»›c 2006, polymer tá»« 2006.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: ChÃ¹a Cáº§u (Há»™i An, Quáº£ng Nam).""",

    "50k": """PhÃ¡t hÃ nh: polymer tá»« 2003.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: NghÃªnh LÆ°Æ¡ng ÄÃ¬nh â€“ Phu VÄƒn LÃ¢u (Huáº¿).""",

    "100k": """PhÃ¡t hÃ nh: polymer tá»« 2004.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: VÄƒn Miáº¿u â€“ Quá»‘c Tá»­ GiÃ¡m (HÃ  Ná»™i).""",

    "200k": """PhÃ¡t hÃ nh: polymer tá»« 2006.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: HÃ²n Äá»‰nh HÆ°Æ¡ng (Vá»‹nh Háº¡ Long, Quáº£ng Ninh).""",

    "500k": """PhÃ¡t hÃ nh: polymer tá»« 2003.
Máº·t trÆ°á»›c: ChÃ¢n dung Chá»§ tá»‹ch Há»“ ChÃ­ Minh.
Máº·t sau: NhÃ  sÃ n BÃ¡c Há»“ táº¡i LÃ ng Sen (Kim LiÃªn, Nghá»‡ An)."""
}



# -----------------------------
# HÃ m dá»± Ä‘oÃ¡n
# -----------------------------
def predict_money(image):
    # Äá»c áº£nh tá»« input Gradio
    img = np.array(image.convert("RGB"))
    img_resized = cv2.resize(img, (IMG_WIDTH, IMG_HEIGHT)) / 255.0
    img_flattened = img_resized.reshape(1, -1)

    # Dá»± Ä‘oÃ¡n
    prediction = model.predict(img_flattened)
    idx = np.argmax(prediction)
    confidence = np.max(prediction) * 100
    predicted_class = CLASS_NAMES[idx]

    # Lá»‹ch sá»­ ra Ä‘á»i
    history_text = history_info.get(predicted_class, "ChÆ°a cÃ³ thÃ´ng tin.")

    # Káº¿t quáº£
    result_text = (
        f"ğŸ’µ Má»‡nh giÃ¡: {predicted_class}\n"
        f"ğŸ“Š Äá»™ tin cáº­y: {confidence:.2f}%\n\n"
        f"ğŸ“œ Lá»‹ch sá»­ ra Ä‘á»i: {history_text}"
    )
    return img_resized, result_text

# -----------------------------
# Giao diá»‡n Gradio
# -----------------------------
demo = gr.Interface(
    fn=predict_money,
    inputs=gr.Image(type="pil", label="ğŸ“¤ Táº£i áº£nh tiá»n lÃªn"),
    outputs=[
        gr.Image(type="numpy", label="ğŸ“· áº¢nh sau khi xá»­ lÃ½"),
        gr.Textbox(label="ğŸ” Káº¿t quáº£ & Lá»‹ch sá»­")
    ],
    title="ğŸ’µ Nháº­n diá»‡n tiá»n Viá»‡t Nam báº±ng ANN",
    description="Upload áº£nh tiá»n Viá»‡t Nam (1k â†’ 500k) Ä‘á»ƒ phÃ¢n loáº¡i má»‡nh giÃ¡ vÃ  xem thÃ´ng tin lá»‹ch sá»­ phÃ¡t hÃ nh."
)

demo.launch(debug=True)
